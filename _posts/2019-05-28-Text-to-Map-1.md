---
title: Processing Geographical Data
subtitle: Homework // L10 Text to Map (1/2)
---
<b>Task:</b> <i>GISting the “Dispatch” II: Mapping geographical data from the “Dispatch”</i><br>

<b>Task 1:</b> <i>Extract toponyms (place names) from the “Dispatch” (python)</i><br>
<b>Task 2:</b> <i>Calculate their frequencies (python)</i><br>
<b>Task 3:</b> <i>Generate files for all years, all months, and all days (you can save results in subfolders, but, better, in single files with dates in another column)</i><br>

### Solution 1: Extracting toponyms



### Reformating Getty Geographical Thesaurus (from XML)
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">re</span><span class="p">,</span> <span class="n">os</span>

<span class="n">source</span> <span class="o">=</span> <span class="s">"path_to_the_folder_with_TGN_xml_files"</span>

<span class="k">def</span> <span class="nf">generateTGNdata</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>

    <span class="n">lof</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="n">tgnList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tgnListNA</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">lof</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"TGN"</span><span class="p">):</span> <span class="c"># fileName test</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="o">+</span><span class="n">f</span><span class="p">,</span> <span class="s">"r"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f1</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="n">data</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"&lt;/Subject&gt;"</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> +"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                    <span class="c">#print(d)</span>

                    <span class="k">if</span> <span class="s">"Subject_ID"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                        <span class="c"># SUBJECT ID</span>
                        <span class="n">placeID</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r"Subject_ID=\"(\d+)\""</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="c">#print(placeID)</span>

                        <span class="c"># NAME OF THE PLACE</span>
                        <span class="n">placeName</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r"&lt;Term_Text&gt;([^&lt;]+)&lt;/Term_Text&gt;"</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="c">#print(placeName)</span>

                        <span class="c"># COORDINATES</span>
                        <span class="k">if</span> <span class="s">"&lt;Coordinates&gt;"</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                            <span class="n">latGr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r"&lt;Latitude&gt;(.*)&lt;/Latitude&gt;"</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">lat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r"&lt;Decimal&gt;(.*)&lt;/Decimal&gt;"</span><span class="p">,</span> <span class="n">latGr</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                            <span class="n">lonGr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r"&lt;Longitude&gt;(.*)&lt;/Longitude&gt;"</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">lon</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r"&lt;Decimal&gt;(.*)&lt;/Decimal&gt;"</span><span class="p">,</span> <span class="n">lonGr</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c">#print(lat)</span>
                            <span class="c">#print(lon)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lat</span> <span class="o">=</span> <span class="s">"NA"</span>
                            <span class="n">lon</span> <span class="o">=</span> <span class="s">"NA"</span>

                        <span class="n">tgnList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">placeID</span><span class="p">,</span> <span class="n">placeName</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]))</span>
                        <span class="c">#input(tgnList)</span>

                        <span class="k">if</span> <span class="n">lat</span> <span class="o">==</span> <span class="s">"NA"</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="o">+</span> <span class="s">"; "</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">placeID</span><span class="p">,</span> <span class="n">placeName</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]))</span>
                            <span class="n">tgnListNA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">placeID</span><span class="p">,</span> <span class="n">placeName</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">]))</span>

    <span class="c"># saving</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s">"tgnID</span><span class="se">\t</span><span class="s">placename</span><span class="se">\t</span><span class="s">lat</span><span class="se">\t</span><span class="s">lon</span><span class="se">\n</span><span class="s">"</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"tgn_data_light.tsv"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f9a</span><span class="p">:</span>
         <span class="n">f9a</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">+</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tgnList</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"tgn_data_light_NA.tsv"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">"utf8"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f9b</span><span class="p">:</span>
         <span class="n">f9b</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="o">+</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tgnListNA</span><span class="p">))</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"TGN has </span><span class="si">%</span><span class="s">d items"</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">tgnList</span><span class="p">))</span>

<span class="n">generateTGNdata</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

<span class="c">#TGN has 2,487,572 items</span>
<span class="c">#    17,613 items do not have coordinates.</span>

</code></pre></div></div>


### Solution 2: Calculating frequencies

```
import re, os

def loadTGN(tgnTSV):
    with open(tgnTSV, "r", encoding="utf8") as f1:
        data = f1.read().split("\n")

        dic = {}

        for d in data:
            d = d.split("\t")

            dic[d[0]] = d

    return(dic)

def match(freqFile, dicToMatch):
    with open(freqFile, "r", encoding="utf8") as f1:
        data = f1.read().split("\n")

        dataNew = []
        dataNewNA = []
        count = 0

        for d in data[1:]:
            tgnID = d.split("\t")[1]
            freq  = d.split("\t")[0]

            if tgnID in dicToMatch:
                val = "\t".join(dicToMatch[tgnID])
                val  = val + "\t" + freq

                if "\tNA\t" in val:
                    dataNewNA.append(val)
                else:
                    dataNew.append(val)
            else:
                print("%s (%d) not in TGN!" % (tgnID, int(freq)))
                count += 1

    header = "tgnID\tplacename\tlat\tlon\tfreq\n"

    with open("coord_"+freqFile, "w", encoding="utf8") as f9a:
        f9a.write(header + "\n".join(dataNew))

    with open("coord_NA_"+freqFile, "w", encoding="utf8") as f9b:
        f9b.write(header + "\n".join(dataNewNA))

    print("%d item have not been matched..." % count)

dictionary = loadTGN("tgn_data_light.tsv")

match("dispatch_toponyms_1861.tsv", dictionary)
match("dispatch_toponyms_1862.tsv", dictionary)
match("dispatch_toponyms_1863.tsv", dictionary)
match("dispatch_toponyms_1864.tsv", dictionary)
match("dispatch_toponyms_1865.tsv", dictionary)
```

### Solution 3: Generating files
